

/// Các biến cho viên đặc biệt
var melonNgang = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415993670_769521041900568_2442095872604535659_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=510075&_nc_eui2=AeFMOPwPax4wsjeTxGgGxBxZNaYehiZIgrQ1ph6GJkiCtO-3kTPRPjOqJo6p4N67lwczysveVFl3yg-UhfqJ-EDw&_nc_ohc=9MLuVr3M17YAX-2R2LW&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdSCG42qDfy-dXuRlMBPNWLvHbiFzfDATZQ_PCfymIgRNw&oe=65DFD24E'
var melonDoc = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415666478_2381529852032691_4816161594463510263_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=510075&_nc_eui2=AeGC7oXGUnJo0-a9QDXEL8u3VWAjC5WjDIlVYCMLlaMMiQfddsD3EWFctpmacj8QTK-ahllmV-7cKhCBmrsmBxav&_nc_ohc=mlmsYeZ1i5cAX_v-up9&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdSaXAfGvUzeCJXbgSyazEGCDHZxDfOV2pJX9W4BtGfc9w&oe=65DFD06A'

var heartNgang = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415794754_923409869191203_4595247974034810682_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=510075&_nc_eui2=AeGgVhnv6GNpFdZKf3sliaItIH-bz6QlSTMgf5vPpCVJM4wn53hO9yglA6RpyyPGdcpR_oDcHTMAadsEFnpySSGX&_nc_ohc=l8UCi-fCLHsAX8R8yK5&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdQlPis96MKsg70L1HLHL8O4H99FeMUX9Fotcz0MbxLfTQ&oe=65DFCD68'
var heartDoc = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415813686_915190029846803_1819786914000242028_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=510075&_nc_eui2=AeFux4AQVS5Xu9VZtDOCkmALDff0o8e3zRAN9_Sjx7fNEDX666o2uFc02oQt3u5OO_xT8laprEHweA2B2ODueMbd&_nc_ohc=yy3p1kt_CscAX-loCVb&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdQHYOwDy30yo8gaaYH-sk1ifr_EyLXThjTBJnai8AmOsQ&oe=65DFDFB6'

var waterNgang = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415989087_1776678422801290_6885139645347593040_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=510075&_nc_eui2=AeHdshmxJGZGPl2_LiznpgaXZzch0dZAPO9nNyHR1kA877Aoy34OBxlUzrt89md-giTIPnsl7GJ3y7uYU7WP7ORi&_nc_ohc=sHTIn5HRxo0AX_wMu0i&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdT46sSut5nRxVDG9lRaruQq8FwQiszDiYjh-9-UeLdnLA&oe=65DFC4C9'
var waterDoc = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/416042263_233312559825122_1520062130367640108_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=510075&_nc_eui2=AeGvjPLspXgXcuae4P0qok8aWBSKVzFJXe1YFIpXMUld7dxhojZIRBPnps-yRZBcr-4lYEcCfyY1rdJrRJBClJ57&_nc_ohc=2ejjl7RSpesAX97yQFC&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdRldRKc1DST7xkkgsoXPVG6T5k4gfDfLavcFnEMc1FTUw&oe=65DFEB58'

var yinyangNgang = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415715895_1768078597004579_7008160831722332772_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=510075&_nc_eui2=AeE-YMgZWVFduPxSSusnMMXxFmnRxW0SKcoWadHFbRIpyr9hs45A0imJBh4yjVM-UGZAtlm--Sgz76pFTrzwE6vY&_nc_ohc=1WQkJdGDHIoAX-a182w&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdT_vM_vrnf_wdm2grZ7AKSTZ7n9CHE85XeB6uVDlZdobQ&oe=65DFC2A6'
var yinyangDoc = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415779259_719829696614819_7075938053816391292_n.jpg?_nc_cat=102&ccb=1-7&_nc_sid=510075&_nc_eui2=AeFQ-q-gNPmgDzeIrwppjwVLyjoqKv_13L_KOioq__Xcv4gdtqrWTTHkD2Bqp5qouWoEcK7My9RfbFrGem4VIKBU&_nc_ohc=GvaNxBf-WS4AX96AlLp&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdQPiFLBlGo7rwRaO-VZM85AyQ5iEUly9l2qdbVaobJE5w&oe=65DFDC78'

var swordNgang = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/416029877_363793416407930_2323911269152227459_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=510075&_nc_eui2=AeFQ9B_SaQKfKvYdP3mZhDfao5cYX6fIvw-jlxhfp8i_D4ZUYJ-vJ30zJN70ya6mSr-XmI53IzaUsqzLeyhfuvxG&_nc_ohc=4_AM-j0SZ44AX8_xSwx&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdShuVYyzoknDPQd14bMOjEkeNjXOQYepEDYixD0B6XX8A&oe=65DFB68D'
var swordDoc = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/416103839_924678375676745_5133161537133660389_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=510075&_nc_eui2=AeHYjaYmpTQFd1rxiSJA8poZCvgdxfHFqocK-B3F8cWqh2_KzJO1gsiW3Se19Uqq5Jj0RG1iA5iVQBFX8MciJZSG&_nc_ohc=vQolQCyaibEAX9dkK8h&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdSKdlNSOO_grC5FglQaF5SJ97UVUMOcN6aGWW5hpLgcFQ&oe=65DFD6CB'

var starNgang = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/400746102_193895663815033_4369722486619850039_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=510075&_nc_eui2=AeGstk-sfPz8uuna578r0IdISPohC5bRfQRI-iELltF9BM-S2zYhy8uJi2Me-V6X2OvCea42tcxJavi-mClpQmUt&_nc_ohc=YF_VGaR2WgQAX-cOeEm&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdRXYUpPkAlA6QlRlfc57nTxWgKq9LftJjRHZKBs4mXVNQ&oe=65DFE5EA'
var starDoc = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/416106092_705540598333758_9087815939519609496_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=510075&_nc_eui2=AeGKaMSyIvWBKUmOCnsKYPWxE20i7s53hKYTbSLuzneEphHZwYk6gxB7fQBr2YRTHGupMHUL86udTBf8Ug-OnxmF&_nc_ohc=7O-KG9P3CZ4AX88SdDt&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdR-wKDCrq8x8MCsbjyi9jN7zZ_hfSg2pfPfslzX0PFXbQ&oe=65DFC20F'

var fiveBlock = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415779252_1687735858419026_1279514988863500876_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=510075&_nc_ohc=SxeoFnD9X1EAX-m6hr6&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdRdIIyjqU_qOKrLVLTbPh7nuEi3FnLjNFgbY3qnvw6Z8Q&oe=65E3AB82'
var melon3x3 = 'https://scontent.fsgn2-7.fna.fbcdn.net/v/t1.15752-9/415552276_883417743329290_5760261224251872829_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=510075&_nc_ohc=8NF8a_aiVbcAX86q6JL&_nc_ht=scontent.fsgn2-7.fna&oh=03_AdQZoVaR70aeGrSyLEcghGvdV67MPMsKTdMYOIToCIz6Gg&oe=65E3C6B1'
var heart3x3 = 'https://scontent.fsgn2-6.fna.fbcdn.net/v/t1.15752-9/416524379_1641029899638859_1410628571081637374_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=510075&_nc_ohc=tBVoqCQOi8gAX8qHJ73&_nc_ht=scontent.fsgn2-6.fna&oh=03_AdRBXHfwFKtf0g_6ql89aUvs8eHA6CjqwzX5x2ZiCXX_UA&oe=65E3B7F0'
var sword3x3 = 'https://scontent.fsgn2-10.fna.fbcdn.net/v/t1.15752-9/414387768_1136974081050216_8682184307687342785_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=510075&_nc_ohc=ZIjHU_AbGtAAX858yDK&_nc_ht=scontent.fsgn2-10.fna&oh=03_AdQKL7ihjWIOnFK6m8pOWWC3ho3Kh2Tj5-FOwx28UUQyLw&oe=65E3D988'
var yinyang3x3 = 'https://scontent.fsgn2-10.fna.fbcdn.net/v/t1.15752-9/416228814_1390538054919469_5190161884989550427_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=510075&_nc_ohc=jT2EUdSIr0gAX9wsDdD&_nc_ht=scontent.fsgn2-10.fna&oh=03_AdRNA6vnztozngAu1UNa1jYRNLfqOSO-v7GQ6Fs8VQWUcg&oe=65E3B4C4'
var star3x3 = 'https://scontent.fsgn2-5.fna.fbcdn.net/v/t1.15752-9/420550326_2278116259051056_8008465044323889736_n.jpg?_nc_cat=104&ccb=1-7&_nc_sid=510075&_nc_ohc=rgp8erPpXrQAX9OpxOM&_nc_ht=scontent.fsgn2-5.fna&oh=03_AdT3WQC_qb2jUGQEc_DyyaRzDF7gxpJ4hM6Q9-folpJ7Pw&oe=65E3E365'
var water3x3 = 'https://scontent.fsgn2-6.fna.fbcdn.net/v/t1.15752-9/416038977_839885894494298_8979224047729924987_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=510075&_nc_ohc=lOb4iv8XZywAX_g_GuJ&_nc_ht=scontent.fsgn2-6.fna&oh=03_AdQVi3R3hpYW1NJr5PIEgBk9MDTbQ2XSRU3sqlBt-CFloQ&oe=65E3D737'
// các biến cho các viên bình thường 
var special = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/415779252_1687735858419026_1279514988863500876_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=510075&_nc_ohc=SxeoFnD9X1EAX-m6hr6&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdRdIIyjqU_qOKrLVLTbPh7nuEi3FnLjNFgbY3qnvw6Z8Q&oe=65E3AB82';


var block = class { constructor(name, src) {
    this.name = name;
    this.src = src;
}}

// các biến cho các viên bình thường 
// var star = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/421316821_2352999254897558_8375811345163435152_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=510075&_nc_ohc=O5FUURn4WeoAX9W2QQ6&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdSBW0UFmtiadJ7GuarUUpakgNge4ky3EzNyKP7uXb_TzQ&oe=65EBE62C'
// var yingyang = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/421809701_762220595931845_8704852172982755247_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=510075&_nc_ohc=r-ppQ8ZqNZEAX9gj9E1&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdRcKuF7a7Wh0dagmI9ra4JE0eRYLux7p9zh62zfgP4tIQ&oe=65EBD782'
// var sword = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/413466115_1362946924340719_5660391729943672205_n.png?_nc_cat=108&ccb=1-7&_nc_sid=510075&_nc_eui2=AeHEiWxKXVd9SW_EUfkts6WyOxW-HxD0qak7Fb4fEPSpqfsQakeLRHSHxN_0lZdS4w86PVkDKuR1eBb1mxc3OtsJ&_nc_ohc=G8U3Rb3lL-0AX-15bUs&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdRkeGn56wJPtSxkw0XjVzhyUrnpY3TLblDw60Igm29xQw&oe=65C3A9A0'
// var water = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/411019611_815782587019913_6541505757016858131_n.png?_nc_cat=101&ccb=1-7&_nc_sid=510075&_nc_eui2=AeFyAt4juRnbweOjSyd9ivQCyGhgOjmkcPLIaGA6OaRw8t7Z2ArbXJIflqVssXdiLb9yBpPOPklIkjTfxvyX3Rrq&_nc_ohc=kFfABs56aisAX_47PPR&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdQJSWowquSeXCWt6fb6jchDgMl44nXZaRZBH1rSxdkuTA&oe=65C38326'
// var heart = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/411123765_2126178954425450_6024970361687618085_n.png?_nc_cat=102&ccb=1-7&_nc_sid=510075&_nc_eui2=AeEZf-AHXm51KqKJom7F1uGSFiVFwQarLloWJUXBBqsuWlGDkB4n2gCD40zNhXs1_SzSI9_Nm0GG5wUpq1OkVtJa&_nc_ohc=ki_gTn4hcTgAX-_bf5m&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdTxSSSnNhw4Y5QlTV7pMyiByc6VtBo7qKebyp0xXLM8qQ&oe=65C388B5'
// var melon = 'https://scontent.xx.fbcdn.net/v/t1.15752-9/411115202_1093865118414101_2848535251316015944_n.png?_nc_cat=107&ccb=1-7&_nc_sid=510075&_nc_eui2=AeFJkE4r9uN9EiwFFT1CNEOA1T_6-6Ys0QLVP_r7pizRAryQy9j2zsbyXlvbzwuqu0FYyphbPkRbYyqN47gzzAhH&_nc_ohc=7eSuLHCSB9EAX-cwgjq&_nc_ad=z-m&_nc_cid=0&_nc_ht=scontent.xx&oh=03_AdQijKji0Kpzufe6KqusF9rfca5llaJ2kcC3WxoXf_vGgA&oe=65CA1360'
// var blank = 'https://github.com/ImKennyYip/candy-crush/blob/master/images/blank.png?raw=true'
var star = 'https://github.com/kun18911/gameBenhVienQuyDu/blob/main/asset/img/star.png?raw=true'
var yingyang = 'https://github.com/kun18911/gameBenhVienQuyDu/blob/main/asset/img/yingyang.png?raw=true'
var sword = 'https://github.com/kun18911/gameBenhVienQuyDu/blob/main/asset/img/sword.png?raw=true'
var water = 'https://github.com/kun18911/gameBenhVienQuyDu/blob/main/asset/img/water.png?raw=true'
var heart = 'https://github.com/kun18911/gameBenhVienQuyDu/blob/main/asset/img/heart.png?raw=true'
var melon = 'https://github.com/kun18911/gameBenhVienQuyDu/blob/main/asset/img/melon.png?raw=true'
var blank = 'https://github.com/ImKennyYip/candy-crush/blob/master/images/blank.png?raw=true'

var star_block = [star, starNgang, starDoc, star3x3];
var yingyang_block = [yingyang, yinyangNgang, yinyangDoc, yinyang3x3];

var sword_block = [sword, swordNgang, swordDoc, sword3x3];
var water_block = [water, waterNgang, waterDoc, water3x3];
var heart_block = [heart, heartNgang, heartDoc, heart3x3];
var melon_block = [melon, melonNgang, melonDoc, melon3x3];



var special_block = [starDoc, starNgang, star3x3,
    yinyangNgang, yinyangDoc, yinyang3x3,
    swordNgang, swordDoc, sword3x3,
    waterNgang, waterDoc, water3x3,
    heartNgang, heartDoc, heart3x3,
    melonNgang, melonDoc, melon3x3,
    special];
// biến tạo bàn cờ
var chess = [star, yingyang, sword, water, heart, melon]
var board = [];
var rows = 9;
var columns = 9;
// var score = 0;
var currTile = undefined;
var otherTile = undefined;

// ----------------
 function baby()  {
    startGame();

    // setTimeout(function () { runGame() }, 1000)
    // //1/10th of a second

    slideCandy();
}
function randomCandy() {
    return chess[Math.floor(Math.random() * chess.length)]; //0 - 5.99
}

function startGame() {
    var i = 0;
    var board_table = document.getElementById("board");
    for (let r = 0; r < rows; r++) {
        let row = [];

        for (let c = 0; c < columns; c++) {
            // <img id="0-0" src="./images/Red.png">
            let tile = document.createElement("img");
            tile.src = randomCandy();
            tile.classList.add("ch-Chess");

            tile.addEventListener("click", clickabd);
            tile.addEventListener("click", clickabc);
            tile.id = r.toString() + "-" + c.toString();

            board_table.append(tile);
            row.push(tile);

            let tile2 = document.createElement("img");
            tile2.src = randomCandy();

        }
        board.push(row);
    }
}


var abc = true
var amc = true
var b = 0;
var click_a = null
var click_b = null
function clickabc() {
    // if (abce == true) {
    if (abc == true) {
        abc = false
        amc = false
        currTile = this;
        b = currTile.id
        document.getElementById(b).classList.add('focus')
    }
}

var c = 0;
function clickabd() {

    if (amc == false) {
        otherTile = this;
        setTimeout(function () { abc = true }, 5)
        amc = true
        b = currTile.id
        c = otherTile.id
        document.getElementById(b).classList.remove('focus')
        document.getElementById(c).classList.add('outFocus')
        setTimeout(function () {
            document.getElementById(c).classList.remove('outFocus')
        }, 300)
        dragEnd()
    }

}


function dragEnd() {

    if (currTile.src.includes(blank) || otherTile.src.includes(blank)) {
        return;
    }

    let currCoords = currTile.id.split("-"); // id="0-0" -> ["0", "0"]
    let r = parseInt(currCoords[0]);
    let c = parseInt(currCoords[1]);

    let otherCoords = otherTile.id.split("-");
    let r2 = parseInt(otherCoords[0]);
    let c2 = parseInt(otherCoords[1]);

    let moveLeft = c2 == c - 1 && r == r2;
    let moveRight = c2 == c + 1 && r == r2;

    let moveUp = r2 == r - 1 && c == c2;
    let moveDown = r2 == r + 1 && c == c2;

    let isAdjacent = moveLeft || moveRight || moveUp || moveDown;

    if (isAdjacent) {

        let currImg = currTile.src;
        let otherImg = otherTile.src;
        currTile.src = otherImg;
        otherTile.src = currImg;

        // let check = checkValid();
        // if (check) {
        check_special_effect();
        // } else {
        //     setTimeout(() => {

        //         let currImg = currTile.src;
        //         let otherImg = otherTile.src;
        //         currTile.src = otherImg;
        //         otherTile.src = currImg;
        //     }, 100);

        // }
        currTile = undefined;
        otherTile = undefined;
    }
}
function check_special_effect() { // kiểm tra block đặc biệt kết hợp với block thường hay ngang dọc
    if (currTile.src == special && otherTile.src == special) {//xóa hết nếu 2block special
        for (let r = 0; r < board.length; r++) {
            board[r].forEach(element => {
                remove_box(element);
            });
        }
        crushCandy();
    } else {
        if (currTile.src == special || otherTile.src == special) {
            let rs = null;
            let change_block = null;
            if (currTile.src == special) {
                change_block = otherTile.src;
                if (chess.indexOf(otherTile.src) != -1) {
                    for (let r = 0; r < board.length; r++) {
                        board[r].forEach(element => {
                            if (element.src == otherTile.src) remove_box(element);
                        });
                    }
                    remove_box(currTile);
                }
                else {
                    switch (true) {
                        case star_block.indexOf(otherTile.src) != -1: rs = star_block; break;
                        case yingyang_block.indexOf(otherTile.src) != -1: rs = yingyang_block; break;
                        case sword_block.indexOf(otherTile.src) != -1: rs = sword_block; break;
                        case water_block.indexOf(otherTile.src) != -1: rs = water_block; break;
                        case heart_block.indexOf(otherTile.src) != -1: rs = heart_block; break;
                        case melon_block.indexOf(otherTile.src) != -1: rs = melon_block; break;
                    }
                }

            }
            if (otherTile.src == special) {
                change_block = currTile.src;
                if (chess.indexOf(currTile.src) != -1) {
                    for (let r = 0; r < board.length; r++) {
                        board[r].forEach(element => {
                            if (element.src == currTile.src) remove_box(element);
                        });
                    }
                    remove_box(otherTile);
                } else {
                    switch (true) {
                        case star_block.indexOf(currTile.src) != -1: rs = star_block; break;
                        case yingyang_block.indexOf(currTile.src) != -1: rs = yingyang_block; break;
                        case sword_block.indexOf(currTile.src) != -1: rs = sword_block; break;
                        case water_block.indexOf(currTile.src) != -1: rs = water_block; break;
                        case heart_block.indexOf(currTile.src) != -1: rs = heart_block; break;
                        case melon_block.indexOf(currTile.src) != -1: rs = melon_block; break;
                    }
                }

            }
            if (rs != null) {

                for (let r = 0; r < board.length; r++) {
                    board[r].forEach(element => {
                        if (rs.indexOf(element.src) != -1) {
                            element.src = change_block;
                        }
                    });
                    setTimeout(() => {
                        let array0 = document.querySelectorAll('img[src="' + change_block + '"]');
                        clear_and_special(array0, -1);
                    }, 200);
                }

            }
            setTimeout(function () { slideCandy() }, 500)
        }
        else {
            if (special_block.indexOf(currTile.src) != -1 && special_block.indexOf(otherTile.src) != -1) {
                var arr_list = effect_x_effect();;
                clear_and_special(arr_list, -1);
            }
            //  crushCandy();
        }
    }
    slideCandy();
}
function crushCandy() {
    crushThree_V2();
}

function crushThree_V2() {
    //check rows
    let listOfArrays = [];
    for (let r = 0; r < rows; r++) {
        let array = [];
        let candy1 = board[r][0];
        array.push(candy1);

        for (let c = 1; c < columns; c++) {

            if (group_block(candy1.src) == group_block(board[r][c].src)) {
                array.push(board[r][c]);
            } else {
                candy1 = board[r][c];
                if (array.length >= 3) listOfArrays.push(array);
                array = [];
                array.push(candy1);
            }
            if (c == (columns - 1)) { if (array.length >= 3) listOfArrays.push(array); }
        }
    }
    //check columns
    for (let c = 0; c < columns; c++) {
        let candy1 = board[0][c];
        let array = [];
        array.push(candy1);
        for (let r = 1; r < rows; r++) {
            if (group_block(candy1.src) == group_block(board[r][c].src)) {
                array.push(board[r][c]);
            } else {
                candy1 = board[r][c];
                if (array.length >= 3) listOfArrays.push(array);
                array = [];
                array.push(candy1);
            }
            if (r == (rows - 1)) {
                if (array.length >= 3) listOfArrays.push(array);
            }
        }
    }

    let block_3x3 = document.querySelectorAll(".class3x3");
    if (block_3x3.length != 0) {
        clear_and_special(block_3x3, -1);
        setTimeout(function () { slideCandy() }, 500)
    }

    var rs = get_all_clear(listOfArrays);
    if (rs.length != 0) {
        rs.forEach(element => {
            if (element.length > 3) {
                if (currTile != undefined && otherTile != undefined) {
                    if (element.indexOf(currTile) != -1) {
                        clear_and_special(element, element.indexOf(currTile));
                    }
                    if (element.indexOf(otherTile) != -1) {
                        clear_and_special(element, element.indexOf(otherTile));
                    }
                }
                else {
                    var duplicate = element.filter((item, index) => element.indexOf(item) != index);
                    if (duplicate.length > 0) {
                        clear_and_special(element, [... new Set(element)].indexOf(duplicate[0]));
                    } else {
                        var randomNum = Math.floor(Math.random() * (element.length - 1));
                        clear_and_special(element, randomNum);
                    }
                }
            } else {
                clear_and_special(element, -1);
            }

        });
    }
    if (rs.length != 0) {
        setTimeout(function () { slideCandy() }, 500)
    }
}
//xử lý 2 khối hiệu ứng hợp nhau
function effect_x_effect() {
    var effect_ngang = [starNgang, yinyangNgang, swordNgang, waterNgang, heartNgang, melonNgang];
    var effect_doc = [starDoc, yinyangDoc, swordDoc, waterDoc, heartDoc, melonDoc];
    var effect_3x3 = [star3x3, yinyang3x3, sword3x3, water3x3, heart3x3, melon3x3];
    let effect1, effect2;
    var arr_list = [];
    switch (true) {
        case effect_3x3.indexOf(currTile.src) != -1: effect1 = "3x3";
            break;
        case effect_ngang.indexOf(currTile.src) != -1: effect1 = "ngang";
            break;
        case effect_doc.indexOf(currTile.src) != -1: effect1 = "doc";
            break;
    }
    switch (true) {
        case effect_3x3.indexOf(otherTile.src) != -1: effect2 = "3x3";
            break;
        case effect_ngang.indexOf(otherTile.src) != -1: effect2 = "ngang";
            break;
        case effect_doc.indexOf(otherTile.src) != -1: effect2 = "doc";
            break;
    }
    let curr=null;
    switch (true) {
        case effect1 == "3x3" && effect2 == "ngang":
        case effect1 == "3x3" && effect2 == "doc":
                curr = currTile.id.split("-"); // id="0-0" -> ["0", "0"]
            break;
        case effect1 == "ngang" && effect2 == "3x3":
        case effect1 == "doc" && effect2 == "3x3":
                curr = otherTile.id.split("-"); // id="0-0" -> ["0", "0"]
            break;
        case effect1 == "3x3" && effect2 == "3x3":
                curr = curr.id.split("-"); // id="0-0" -> ["0", "0"]
            break;
        default:
            arr_list.push(currTile);
            arr_list.push(otherTile);
            return arr_list;
    }
    if (curr!=null){
        let r = Number(curr[0]);//lấy hàng
        let c = Number(curr[1]);//lấy cột
        let min_hang = r - 1, min_cot = c - 1, max_hang = r + 1, max_cot = c + 1;
        if (r == 0) { min_hang = r; }
        if (r == (rows - 1)) { max_hang = r; }
        if (c == 0) { min_cot = c; }
        if (c == (columns - 1)) { max_cot = c; }
        for (let i = 0; i < board.length; i++) {
            if (i >= min_hang && i <= max_hang) {
                board[i].forEach(element => {
                    arr_list.push(element);
                });
                continue;
            }
            for (let j = min_cot; j <= max_cot; j++) {
                arr_list.push(board[i][j]);
            }
        }
    }
    
    return arr_list;
}
function group_block(block) {
    if (star_block.indexOf(block) != -1) return star_block;
    if (yingyang_block.indexOf(block) != -1) return yingyang_block;
    if (sword_block.indexOf(block) != -1) return sword_block;
    if (water_block.indexOf(block) != -1) return water_block;
    if (heart_block.indexOf(block) != -1) return heart_block;
    if (melon_block.indexOf(block) != -1) return melon_block;
}
function clear_and_special(array, index) {//mảng bị xóa và ô sẽ thay thế = ô đặc biệt
    let src = "";
    var arr = [... new Set(array)];
    let list_special = [];//mảng các phần tử đặc biệt trong array bị xóa bởi slide
    for (let i = 0; i < arr.length; i++) {
        let index_special = special_block.indexOf(arr[i].src);
        if (index_special != -1) { list_special.push(arr[i]); }
    }
    let affter_effect = [];//mảng bị xóa bởi ô đặc biệt
    if (list_special.length > 0) {
        for (let i = 0; i < list_special.length; i++) {
            affter_effect = affter_effect.concat(special_effect(list_special[i], []));
        }
        let number_special = list_special.length;//số ô đặc biệt ban đầu
        //số ô đặc biệt sau khi lọc ra bị xóa
        let array_special = [... new Set(affter_effect)].filter((item) => { if (special_block.indexOf(item.src) != -1) return item; });
        // kiểm tra số ô đb ban đầu == số ô đb sau khi xóa =>sai thì xử lý tiếp đến khi bằng nhau 
        while (array_special.length > number_special) {
            console.log(array_special, number_special);
            number_special = array_special.length;//gán lại số lượng giá trị mới
            affter_effect = [];
            for (let i = 0; i < array_special.length; i++) {
                affter_effect = affter_effect.concat(special_effect(array_special[i], []));
            }
            //lấy lại danh sách ô đb sau khi bị ảnh hưởng
            array_special = [... new Set(affter_effect)].filter((item) => { if (special_block.indexOf(item.src) != -1) return item; });
        }
        let final_array = [... new Set(affter_effect)];
        if (final_array.length != 0) {
            for (let i = 0; i < final_array.length; i++) {
                remove_box(final_array[i]);
            }
        }
    }
    if (index != -1) {
        if (arr.length == 4) {//ăn 4 ô
            src = create_block4(arr);
        }
        else // ăn >=5 ô
        {
            if (arr.length > 4) {
                src = create_block_5(arr);
            }
        }
        //xóa ô 
        if (src != "") {
            for (let i = 0; i < arr.length; i++) {
                if (arr[i] == arr[index]) {
                    arr[i].src = src;
                }
                else {
                    remove_box(arr[i]);
                }
            }
        }
    } else {
        for (let i = 0; i < arr.length; i++) {
            remove_box(arr[i]);
        }
    }
}
function remove_box(box) {
    if (box.classList.contains("class3x3")) return;

    box.classList.add("hidden");
    setTimeout(function () {
        box.src = blank;
    }, 150);
}

function special_effect(effectbox, remove_list) {
    var effect_ngang = [starNgang, yinyangNgang, swordNgang, waterNgang, heartNgang, melonNgang];
    var effect_doc = [starDoc, yinyangDoc, swordDoc, waterDoc, heartDoc, melonDoc];
    var effect_3x3 = [star3x3, yinyang3x3, sword3x3, water3x3, heart3x3, melon3x3];
    let curr = effectbox.id.split("-"); // id="0-0" -> ["0", "0"]
    let r = Number(curr[0]);//lấy hàng
    let c = Number(curr[1]);//lấy cột

    let list_remove = remove_list;
    switch (true) {
        case (effect_ngang.indexOf(effectbox.src) != -1):
            board[r].forEach(element => {
                list_remove.push(element);
            });
            break;
        case (effect_doc.indexOf(effectbox.src) != -1):
            for (let j = 0; j < board.length; j++) {

                list_remove.push(board[j][c]);
            }
            break;
        case (effect_3x3.indexOf(effectbox.src) != -1):
            let min_hang = r - 1, min_cot = c - 1, max_hang = r + 1, max_cot = c + 1;

            if (r == 0) { min_hang = r; }
            if (r == (rows - 1)) { max_hang = r; }
            if (c == 0) { min_cot = c; }
            if (c == (columns - 1)) { max_cot = c; }
            for (let h = min_hang; h <= max_hang; h++) {
                for (let d = min_cot; d <= max_cot; d++) {
                    if (effect_3x3.indexOf(board[h][d].src) != -1) {
                        if (!effectbox.classList.contains("class3x3")) {
                            effectbox.classList.add("class3x3");
                        } else {
                            if (board[h][d] != null) list_remove.push(board[h][d]);
                            effectbox.classList.remove("class3x3");
                        }
                    }

                    if (board[h][d] != null) list_remove.push(board[h][d]);
                }
            }
            break;
    }
    return list_remove;
}

//xử lý 4 block
function create_block4(array) {
    let src = "";
    let array_number = [];
    for (let i = 0; i < array.length; i++) {
        let curr = array[i].id.split("-"); // id="0-0" -> ["0", "0"]
        let r = Number(curr[0]);//lấy hàng
        let c = Number(curr[1]);//lấy cột
        array_number.push([r, c]);//lưu thành mảng array_number[[1,1],[2,2],[3,3],[4,4]]
    }
    let check = array_number.reduce((total, value) => {
        const [row, colum] = value;//value[row,colum]
        total[0].push(row);//lưu mảng hàng
        total[1].push(colum);//lưu mảng cột
        return total;
    }, [[], []]);//check=total[[1,1,1,1,1],[1,2,3,4,5]]

    if ([...new Set(check[0])].length == 1) {//4 ô hàng 
        switch (array[0].src) {
            case star: src = starDoc; break;
            case sword: src = swordDoc; break;
            case yingyang: src = yinyangDoc; break;
            case water: src = waterDoc; break;
            case heart: src = heartDoc; break;
            case melon: src = melonDoc; break;
        }
    }
    else
        if ([...new Set(check[1])].length == 1) {//4 ô cột
            switch (array[0].src) {
                case star: src = starNgang; break;
                case sword: src = swordNgang; break;
                case yingyang: src = yinyangNgang; break;
                case water: src = waterNgang; break;
                case heart: src = heartNgang; break;
                case melon: src = melonNgang; break;
            }
        }

    return src;
}
//xử lý 5 block
function create_block_5(array) {
    let src = "";
    let array_number = [];
    for (let i = 0; i < array.length; i++) {
        let curr = array[i].id.split("-"); // id="0-0" -> ["0", "0"]
        let r = Number(curr[0]);//lấy hàng
        let c = Number(curr[1]);//lấy cột
        array_number.push([r, c]);//lưu thành mảng array_number[[1,1],[2,2],[3,3],[4,4]]
    }
    let check = array_number.reduce((total, value) => {
        const [row, colum] = value;//value[row,colum]
        total[0].push(row);//lưu mảng hàng
        total[1].push(colum);//lưu mảng cột
        return total;
    }, [[], []]);//check=total[[1,1,1,1,1],[1,2,3,4,5]]
    var ngang = [...new Set(check[0])], doc = [...new Set(check[1])];
    if (ngang.length == 1 || doc.length == 1) {
        src = special;
    } else {
        switch (array[0].src) {
            case star: src = star3x3; break;
            case sword: src = sword3x3; break;
            case yingyang: src = yinyang3x3; break;
            case water: src = water3x3; break;
            case heart: src = heart3x3; break;
            case melon: src = melon3x3; break;
        }
    }

    return src;
}
function get_all_clear(listOfArrays) {
    var return_list = [];
    for (let i = 0; i < listOfArrays.length; i++) {
        let list = listOfArrays[i];
        for (let j = i + 1; j < listOfArrays.length; j++) {
            var dup = [... new Set(list)].filter(item => listOfArrays[j].includes(item));
            if (dup.length > 0) {
                list = list.concat(listOfArrays[j]);
                listOfArrays = listOfArrays.splice(j, 1);
                i = 0;
            }
        }
        return_list.push(list);
    }

    return (return_list);
}

function checkValid() {
    //check rows
    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < columns - 2; c++) {
            let candy1 = board[r][c];
            let candy2 = board[r][c + 1];
            let candy3 = board[r][c + 2];
            if (candy1.src == candy2.src && candy2.src == candy3.src && !candy1.src.includes(blank)) {
                return true;
            }
        }
    }

    //check columns
    for (let c = 0; c < columns; c++) {
        for (let r = 0; r < rows - 2; r++) {
            let candy1 = board[r][c];
            let candy2 = board[r + 1][c];
            let candy3 = board[r + 2][c];
            if (candy1.src == candy2.src && candy2.src == candy3.src && !candy1.src.includes(blank)) {
                return true;
            }
        }
    }

    return false;
}

function slideCandy() {

    var allChess = document.querySelectorAll(".ch-Chess");
    for (let piece of allChess) {
        piece.classList.remove('hidden');
    }
    for (let r = rows - 1; r >= 1; r--) {
        for (let c = columns - 1; c >= 0; c--) {
            if (board[r][c].src == blank) {
                if (board[r - 1][c].classList.contains("class3x3")) {
                    board[r][c].classList.add("class3x3");
                    board[r - 1][c].classList.remove("class3x3");
                }
                board[r][c].src = board[r - 1][c].src
                board[r - 1][c].src = blank
            }
        }
    }
    for (let c = 0; c < columns; c++) {
        if (board[0][c].src.includes(blank)) {
            board[0][c].src = randomCandy();
        }
    }
    setTimeout(() => {
        var allChess = document.querySelectorAll('img[src="' + blank + '"]');

        if (allChess.length != 0) {
            slideCandy();
        } else {
            crushCandy();
        }
    }, 100);
}

function generateCandy() {
    for (let c = 0; c < columns; c++) {
        if (board[0][c].src.includes(blank)) {
            board[0][c].src = randomCandy();
        }
    }
}
function runGame() {
    let validMove = checkValid();
    if (validMove == true) {
        crushCandy()
    }
}
function move_down(col, box) {
    for (let r = rows - 1; r >= 0; r--) {
        board[r][col].offsetTop;
    }
}

